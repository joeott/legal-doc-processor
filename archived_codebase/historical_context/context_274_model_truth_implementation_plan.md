# Context 274: Model Truth Implementation Plan

## Principle: Pydantic Models Define Truth

The Pydantic models in `scripts/core/schemas.py` are the authoritative source. Everything else must conform to them.

## Current Model Behavior (Truth)

1. **UUID Generation**:
   - ProjectModel: Only generates UUID when `project_id=None` is explicitly passed
   - Other models: Require UUID to be provided (no auto-generation)

2. **Field Names**:
   - Primary: snake_case (e.g., `script_run_count`)
   - Aliases: camelCase for compatibility (e.g., `scriptRunCount`)
   - Access: Only snake_case works for attribute access

3. **Timestamps**:
   - Not auto-generated by models
   - Expected to be set by database or application layer

4. **Required vs Optional**:
   - Most fields are Optional with defaults
   - Only core fields are required (e.g., name, document_uuid)

## Required Changes

### 1. Fix Tests (Immediate)

The tests are wrong, not the models. Tests must be updated to:

1. Use snake_case field names:
   ```python
   # Wrong:
   assert project.scriptRunCount == 0
   
   # Correct:
   assert project.script_run_count == 0
   ```

2. Not expect auto-generated UUIDs unless explicitly implemented:
   ```python
   # Wrong:
   project = ProjectModel(name="Test")
   assert project.project_id is not None
   
   # Correct (current behavior):
   project = ProjectModel(name="Test", project_id=None)
   assert project.project_id is not None
   ```

3. Not expect auto-generated timestamps:
   ```python
   # Wrong:
   assert doc.created_at is not None
   
   # Correct:
   assert doc.created_at is None  # Unless set by database
   ```

### 2. Database Schema Alignment

RDS schema must match Pydantic field names and types:

1. **Already Fixed**:
   - `filename` → `file_name`
   - `processing_status` → `status`
   - Created `processing_tasks` table

2. **Still Needed**:
   - Verify all column types match Pydantic types
   - Add DEFAULT CURRENT_TIMESTAMP for timestamp columns
   - Ensure UUID columns accept UUID type

### 3. Remove Column Mappings (Future)

Once database fully aligns with models:
1. Remove `enhanced_column_mappings.py`
2. Remove mapping logic from `rds_utils.py`
3. Use Pydantic models directly

## Implementation Steps

### Phase 1: Fix Tests (Now)
1. Update all tests to use snake_case field names
2. Fix UUID generation expectations
3. Remove timestamp auto-generation assumptions
4. Make tests reflect actual model behavior

### Phase 2: Validate Database Schema
1. Run tests against current RDS schema
2. Identify remaining mismatches
3. Create SQL migrations for fixes

### Phase 3: Apply Database Changes
1. Apply SQL migrations to RDS
2. Re-run all tests
3. Verify full compatibility

### Phase 4: Cleanup
1. Re-enable conformance validation
2. Remove temporary bypasses
3. Remove column mapping layer

## Test Fix Examples

### ProjectModel Test Fix:
```python
def test_project_model_minimal_data():
    """Test ProjectModel creation with minimal data."""
    project = ProjectModel(name="Test Project")
    assert project.name == "Test Project"
    assert project.project_id is None  # No auto-generation without explicit None
    assert project.script_run_count == 0  # Use snake_case
    assert project.processed_by_scripts is False  # Use snake_case
    assert project.active is True
```

### UUID Generation Test Fix:
```python
def test_project_model_project_id_auto_generation():
    """Test project_id auto-generation when explicitly None."""
    project = ProjectModel(name="Test Project", project_id=None)
    assert isinstance(project.project_id, uuid.UUID)
```

## Key Decisions

1. **Models are correct**: Don't change models to match tests
2. **Tests must adapt**: Update tests to match model reality
3. **Database must conform**: RDS schema must support model requirements
4. **No magic**: If models don't auto-generate, that's intentional

## Success Metrics

1. All tests pass without modifying Pydantic models
2. Database schema exactly matches model field names
3. No column mappings needed
4. Scripts use models directly without transformation