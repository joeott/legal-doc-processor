# Test-Code Alignment Fixes for Pydantic Models

## Summary
Fixed test files to align with actual Pydantic model behavior. The tests were making incorrect assumptions about method signatures, field naming conventions, and automatic value generation.

## Key Issues Fixed

### 1. PydanticSerializer.deserialize() Method Signature
**Problem**: Tests were calling `PydanticSerializer.deserialize(model_class, data)` 
**Fix**: Corrected to `PydanticSerializer.deserialize(data, model_class, table_name=None)`

The actual signature in `scripts/db.py` is:
```python
def deserialize(data: Dict[str, Any], model_class: Type[T], table_name: str = None) -> T:
```

### 2. Field Name Convention
**Problem**: Tests were using camelCase aliases (e.g., `scriptRunCount`) to access model attributes
**Fix**: Changed to use snake_case field names (e.g., `script_run_count`)

Pydantic models use snake_case internally but serialize to camelCase via aliases for database compatibility.

### 3. UUID Auto-Generation Behavior
**Problem**: Tests assumed UUIDs were auto-generated by default
**Fix**: UUIDs are only generated when explicitly passing `None` to the field

The validators in schemas.py check:
```python
if v is None:
    return uuid.uuid4()
```

### 4. Timestamp Auto-Generation
**Problem**: Tests assumed `created_at` and `updated_at` were always auto-populated
**Fix**: Removed these assumptions - timestamps can be None if not provided

### 5. Empty String Handling
**Problem**: Tests didn't account for empty string to None conversion
**Fix**: Updated test to expect ValidationError when empty string converts to None for required fields

## Files Modified
1. `/opt/legal-doc-processor/tests/test_db.py`
   - Fixed all PydanticSerializer.deserialize() calls
   - Updated error assertions for empty string handling
   - Corrected mock calls to match actual parameter order

2. `/opt/legal-doc-processor/tests/core/test_schemas.py`
   - Changed all field access from camelCase to snake_case
   - Fixed UUID generation tests to explicitly pass None
   - Removed timestamp auto-generation assumptions
   - Updated error message assertions for Pydantic v2

## Testing Strategy
The fixed tests now:
1. Match the actual implementation behavior
2. Use correct method signatures
3. Follow Python naming conventions for field access
4. Handle optional field behavior correctly
5. Respect actual validation logic

## Next Steps
Run the test suite to verify all fixes work correctly:
```bash
pytest tests/test_db.py -v
pytest tests/core/test_schemas.py -v
```